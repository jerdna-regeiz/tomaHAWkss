from subprocess import call
import os
import copy
from Queue import *
import sys
import salt.client
 #
# TODO talk about exploit format, parameters should be (server, worker) - README

# TODO think about it
online = True  # online 24/7 ?

# TODO where them servers at?  SKRIPTPARAMETER
targetServers = sys.argv[1]  # all the servers we are planning to attack , argv[1] ist targetserverliste

# TODO think about the path - ARGs
path = sys.argv[2]  # path of the exploitfolder
exploits = {}  # hashMap for the exploits. a file/exploit pointing on servers on which it will be executed

workerQueue = Queue()
local = salt.client.LocalClient()
for key in local.cmd('*','cmd.run',['whoami']):
    workerQueue.put(key)

#print("Fehler hier:",local.cmd('*','cmd.run',['python ./lib/hello.py']))
while online:
    for f in os.listdir(path):
	#print("files:",f)
        if f.endswith('.py'):  # find all python scripts
            if f in exploits:
                for server in exploits[f]:
                    worker = workerQueue.get
                    workerQueue.put(worker)
                    print(local.cmd('*','cmd.run',['python ./lib/' + f ]))
                            # assumption -> the exploit returns false,
                            #  if it couldn't do it's thing, true otherwise
                       # exploits[file].remove(
                       #         server)  # remove the server from the targetList
                            # of this exploit, cause they obviously fixed it
            else:
                    exploits[f] = copy.deepcopy(
                        targetServers)  # add a exploit as a key and let it
                    # point to all servers -> it could work everywhere!
